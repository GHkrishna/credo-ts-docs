"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7824],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function d(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),l=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=l(e.components);return a.createElement(s.Provider,{value:t},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,p=d(e,["components","mdxType","originalType","parentName"]),c=l(n),h=i,m=c["".concat(s,".").concat(h)]||c[h]||u[h]||r;return n?a.createElement(m,o(o({ref:t},p),{},{components:n})):a.createElement(m,o({ref:t},p))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=h;var d={};for(var s in t)hasOwnProperty.call(t,s)&&(d[s]=t[s]);d.originalType=e,d[c]="string"==typeof e?e:i,o[1]=d;for(var l=2;l<r;l++)o[l]=n[l];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},7057:function(e,t,n){n.r(t),n.d(t,{assets:function(){return s},contentTitle:function(){return o},default:function(){return u},frontMatter:function(){return r},metadata:function(){return d},toc:function(){return l}});var a=n(3117),i=(n(7294),n(3905));const r={},o="Migrating from an Indy SDK Wallet to Aries Askar",d={unversionedId:"updating/update-indy-sdk-to-askar",id:"updating/update-indy-sdk-to-askar",title:"Migrating from an Indy SDK Wallet to Aries Askar",description:"This documentation explains the process of migrating your Indy-sdk wallet to",source:"@site/guides/updating/update-indy-sdk-to-askar.md",sourceDirName:"updating",slug:"/updating/update-indy-sdk-to-askar",permalink:"/guides/next/updating/update-indy-sdk-to-askar",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Update Assistant",permalink:"/guides/next/updating/update-assistant"},next:{title:"Migrating from AFJ 0.1.0 to 0.2.x",permalink:"/guides/next/updating/versions/0.1-to-0.2"}},s={},l=[{value:"What does the migration do internally?",id:"what-does-the-migration-do-internally",level:2},{value:"Create a backup",id:"create-a-backup",level:3},{value:"Migrate the database to an Aries Askar structure",id:"migrate-the-database-to-an-aries-askar-structure",level:3},{value:"Try to open the wallet in the new Aries Askar structure",id:"try-to-open-the-wallet-in-the-new-aries-askar-structure",level:3},{value:"Update the keys",id:"update-the-keys",level:3},{value:"Update the Dids",id:"update-the-dids",level:3},{value:"Update the credential definitions",id:"update-the-credential-definitions",level:3},{value:"Update the link secret(s) (master secret)",id:"update-the-link-secrets-master-secret",level:3},{value:"Update the credentials",id:"update-the-credentials",level:3},{value:"All the other records",id:"all-the-other-records",level:3},{value:"How to update",id:"how-to-update",level:2},{value:"add the required dependencies:",id:"add-the-required-dependencies",level:3},{value:"Getting the database path",id:"getting-the-database-path",level:3},{value:"Android",id:"android",level:4},{value:"iOS",id:"ios",level:4}],p={toc:l},c="wrapper";function u(e){let{components:t,...n}=e;return(0,i.kt)(c,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"migrating-from-an-indy-sdk-wallet-to-aries-askar"},"Migrating from an Indy SDK Wallet to Aries Askar"),(0,i.kt)("p",null,"This documentation explains the process of migrating your Indy-sdk wallet to\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/hyperledger/aries-askar"},"Aries Askar"),"."),(0,i.kt)("admonition",{type:"danger"},(0,i.kt)("p",{parentName:"admonition"},"While the migration script techinically works on node.js, it is strongly\nadvised not to use it, yet. The mean reason for this is that the Credential\nDefinition migration is not done yet. When a credential definition is detected\nit will revert the migration process and no harm is done.")),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"Postgres is not supported, yet.")),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"The migration script is supported for 0.4.x (or moving from 0.3.x to 0.4.x).\nPlease refer to ",(0,i.kt)("a",{parentName:"p",href:"/guides/next/updating/versions/0.3-to-0.4"},"Migrating from AFJ 0.3.x to 0.4.x"),"\nto get to 0.4.x.")),(0,i.kt)("h2",{id:"what-does-the-migration-do-internally"},"What does the migration do internally?"),(0,i.kt)("p",null,"The migration script does the following to make sure everything is migrated\nproperly, and if anything goes wrong, it will revert back to a working state."),(0,i.kt)("h3",{id:"create-a-backup"},"Create a backup"),(0,i.kt)("p",null,"Because undefined behaviour might occur, we create a backup in the new ",(0,i.kt)("inlineCode",{parentName:"p"},"tmp"),"\ndirectory from Aries Framework JavaScript. if some error occurs, it will be\nreverted back to the backed-up state and if no error occurs, it will delete the\nbackup from the temporary directory."),(0,i.kt)("h3",{id:"migrate-the-database-to-an-aries-askar-structure"},"Migrate the database to an Aries Askar structure"),(0,i.kt)("p",null,"The Indy-sdk and Aries Askar have different database structures. So first of\nall we need to change some table names, decrypt all the items with the old Indy\nkeys, encrypt the items with the new Aries Askar keys and store them inside the\nnew structure."),(0,i.kt)("h3",{id:"try-to-open-the-wallet-in-the-new-aries-askar-structure"},"Try to open the wallet in the new Aries Askar structure"),(0,i.kt)("p",null,"When the wallet is correctly transformed, the wallet will be attempted to be\nopenend."),(0,i.kt)("h3",{id:"update-the-keys"},"Update the keys"),(0,i.kt)("p",null,"Aries Askar has a specific way to store keys and every key, defined by the\ncategory of ",(0,i.kt)("inlineCode",{parentName:"p"},"Indy::Key")," will be migrated."),(0,i.kt)("h3",{id:"update-the-dids"},"Update the Dids"),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"This update script does not transform did records. This is fine for something\nlike ",(0,i.kt)("inlineCode",{parentName:"p"},"did:peer"),", but will cause issues with ",(0,i.kt)("inlineCode",{parentName:"p"},"indy")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"sov")," dids. For more\ninformation, please check out the ",(0,i.kt)("a",{parentName:"p",href:"/guides/next/updating/versions/0.3-to-0.4#removal-of-publicdidseed-and-publicdid"},"Migrating from AFJ 0.3.x to\n0.4.x"))),(0,i.kt)("h3",{id:"update-the-credential-definitions"},"Update the credential definitions"),(0,i.kt)("admonition",{type:"danger"},(0,i.kt)("p",{parentName:"admonition"},"Updating of credential definitions is not yet supported. This is why it is\nstrongly advised not to run this script in a node.js environment.")),(0,i.kt)("h3",{id:"update-the-link-secrets-master-secret"},"Update the link secret(s) (master secret)"),(0,i.kt)("p",null,"The link sercets, identified by the category ",(0,i.kt)("inlineCode",{parentName:"p"},"Indy::MasterSecret"),", are updated\nnext. They are stored inside a new ",(0,i.kt)("inlineCode",{parentName:"p"},"AnonCredsLinkSecretRecord"),"."),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"Since we have to set a default link secret, some additional logic is added to\ndetect this. You can either supply a ",(0,i.kt)("inlineCode",{parentName:"p"},"defaultLinkSercetId")," as a constructor\nparameter or it will be based on your ",(0,i.kt)("inlineCode",{parentName:"p"},"walletId"),"."),(0,i.kt)("p",{parentName:"admonition"},"If there is no Indy record with the ",(0,i.kt)("inlineCode",{parentName:"p"},"defaultLinkSecretId")," or the ",(0,i.kt)("inlineCode",{parentName:"p"},"walletId"),", an\nerror will be thrown and the migration will be restored.")),(0,i.kt)("h3",{id:"update-the-credentials"},"Update the credentials"),(0,i.kt)("p",null,"The credentials, identified by the category ",(0,i.kt)("inlineCode",{parentName:"p"},"Indy::Credential")," are updated\nlast. They are stored in the new ",(0,i.kt)("inlineCode",{parentName:"p"},"AnonCredsCredentialRecord")," as a one-to-one\ncopy. This means that they now support more tags and will make querying a lot\neasier."),(0,i.kt)("h3",{id:"all-the-other-records"},"All the other records"),(0,i.kt)("p",null,"All the other records will be transferred without any updates as they are not\nIndy specific."),(0,i.kt)("h2",{id:"how-to-update"},"How to update"),(0,i.kt)("p",null,"Updating does not require a lot of code, but must be done with caution."),(0,i.kt)("p",null,"It is very important to note that the migration script only has to be run once.\nIf it runs for a second time, it will error saying that the database is already\nmigrated. Also, when the migration is finished, it is common practise to store\nthis state in your persistent app storage. This script does not provide a way\nto detect if an update has happened, so storing this value will prevent the\nscript from running every time. For more information regarding this topic,\nplease check out ",(0,i.kt)("a",{parentName:"p",href:"/guides/next/updating/update-assistant#storing-the-agent-storage-version-outside-of-the-agent-storage"},"Update\nAssistant"),"."),(0,i.kt)("h3",{id:"add-the-required-dependencies"},"add the required dependencies:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"yarn add @hyperledger/aries-askar-react-native @aries-framework/indy-sdk-to-askar-migration react-native-fs\n")),(0,i.kt)("p",null,"Below is the minimal code required for the migration to work. It is recommended\nto turn the logger on as it gives a lot of information regarding the migration."),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"The agent is not allowed to be initialized to run this script. This makes sure\nnothing else happens during the migration.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import { IndySdkToAskarMigrationUpdater } from '@hyperledger/indy-sdk-to-askar-migration'\nimport { agentDependencies } from '@aries-framework/react-native'\nimport { AskarModule } from '@aries-framework/askar'\n\nconst oldAgent = new Agent({\n  config: {\n    /* ... */\n  },\n  modules: {\n    modules: { askar: new AskarModule() },\n  },\n  dependencies: agentDependencies,\n})\n\nconst dbPath = '' // see section below\n\nconst updater = await IndySdkToAskarMigrationUpdater.initialize({ dbPath, agent })\nawait updater.update()\n")),(0,i.kt)("h3",{id:"getting-the-database-path"},"Getting the database path"),(0,i.kt)("h4",{id:"android"},"Android"),(0,i.kt)("p",null,"On android, the database is commonly located under the ",(0,i.kt)("inlineCode",{parentName:"p"},"ExternalDirectoryPath"),"."),(0,i.kt)("p",null,"If you did not follow the default indy-sdk for React Native setup, your path\nmight differ. Check out step 5 of ",(0,i.kt)("a",{parentName:"p",href:"/guides/next/getting-started/installation/react-native/android#adding-the-android-indy-sdk-libaries"},"Adding the Android Indy-sdk\nlibraries"),"\nfor the default behaviour."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import fs from 'react-native-fs'\n\nconst base = fs.ExternalDirectoryPath\nconst indyClient = '.indy_client'\nconst wallet = 'wallet'\nconst walletId = agent.config.walletConfig.walletId\nconst file = 'sqlite.db'\n\nconst dbPath = `${base}/${indyClient}/${wallet}/${walletId}/${file}`\n")),(0,i.kt)("h4",{id:"ios"},"iOS"),(0,i.kt)("p",null,"On iOS, the database is commonly located under the ",(0,i.kt)("inlineCode",{parentName:"p"},"DocumentDirectoryPath"),"."),(0,i.kt)("p",null,"For iOS this can only change if your phone does not have the ",(0,i.kt)("inlineCode",{parentName:"p"},"HOME")," environment\nvariable set. This is not usual behaviour, and if ",(0,i.kt)("inlineCode",{parentName:"p"},"HOME")," is not set, the ",(0,i.kt)("inlineCode",{parentName:"p"},"base"),"\nin the code section below will be ",(0,i.kt)("inlineCode",{parentName:"p"},"/home/indy/Documents"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import fs from 'react-native-fs'\n\nconst base = fs.DocumentDirectoryPath\nconst indyClient = '.indy_client'\nconst wallet = 'wallet'\nconst walletId = agent.config.walletConfig.walletId\nconst file = 'sqlite.db'\n\nconst dbPath = `${base}/${indyClient}/${wallet}/${walletId}/${file}`\n")))}u.isMDXComponent=!0}}]);